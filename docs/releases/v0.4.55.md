# db-mcp v0.4.55

## Highlights

### Depth-Aware File Classification
The additive file classifier now respects directory depth. Previously, `examples/*.yaml` would match files at any depth (e.g., `examples/nested/deep.yaml`) due to Python's `fnmatch` treating `*` as matching `/`. Now `*` only matches within a single directory level, and `**` is supported for recursive matching. This prevents nested files from being auto-merged when they shouldn't be.

### Selective Additive Merge
When a collaborator branch contains both additive and shared-state changes, additive files are now selectively merged to main while shared-state changes go through the PR review flow. Previously, any shared-state file on the branch would block all additive files from merging.

### Merge Conflict Recovery
Auto-merge operations (both `collaborator_push` and `master_merge_all`) now catch merge conflicts gracefully. On conflict, the merge is aborted and the changes fall back to the PR flow instead of crashing the sync pipeline.

### .collab.yaml Auto-Merge
Member additions to `.collab.yaml` are now treated as auto-mergeable. When a collaborator joins and the only shared-state change is `.collab.yaml`, it auto-merges without requiring a master PR review. If it conflicts, the merge conflict handler falls back to PR.

### Merge-Base Diffing
Collaborator diffs now use `git merge-base` instead of diffing against HEAD of main. This means only the collaborator's actual changes are classified, not accumulated drift from other merges or master-pushed files.

### Branch Pruning
New `db-mcp collab prune` command and `prune_merged_branches()` function. Finds remote `collaborator/*` branches fully merged into main and deletes them. Also runs automatically at the end of `master_merge_all()`.

### Force-With-Lease Push
Collaborator branch pushes now use `--force-with-lease` to handle re-pushes when the remote branch already exists, without risking data loss.

## Breaking changes
- None

## Features
- Depth-aware `_match_pattern()` replacing `fnmatch` in file classification
- `is_auto_mergeable_shared()` for `.collab.yaml` auto-merge detection
- Selective file checkout (`git checkout <branch> -- <file>`) for mixed additive/shared branches
- `git.merge_base()` for accurate collaborator diffs
- `git.checkout_file()` for selective file merging
- `git.merge_abort()` for conflict recovery
- `git.delete_remote_branch()` for branch cleanup
- `git.list_merged_remote_branches()` for finding prunable branches
- `git.push_branch()` now supports `force_with_lease` parameter
- `db-mcp collab prune` CLI command
- Auto-pruning in `master_merge_all()`

## Fixes
- `fnmatch` `*` matching across directory separators (e.g., `examples/*.yaml` matching `examples/nested/file.yaml`)
- Additive files blocked by shared-state on same branch
- Merge conflicts crashing sync pipeline
- `.collab.yaml` member additions requiring unnecessary PR review
- Collaborator diffs polluted by master-pushed files already on both branches
- `push_branch` failing when remote branch already exists

## Security
- None

## Upgrade notes
- None

## Known issues
- None

## Test Coverage
- Python: 105 collab tests passing
- Integration test: 15/17 scenarios passing (2 minor push-coordination issues in local bare repo test setup)
