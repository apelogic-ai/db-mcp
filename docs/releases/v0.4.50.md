# Release v0.4.50 - Collaborative Git Sync Protocol

**Release Date:** February 6, 2026

## Overview

This release introduces a collaboration protocol for shared knowledge vaults. A master sets up a connection and invites collaborators to join via git. Collaborators contribute examples, learnings, and traces that auto-merge, while shared-state changes (schema, business rules) go through PRs for master review. Background sync keeps vaults in near-sync without burdening collaborators with git mechanics.

## Highlights

### Team Knowledge Sharing

Multiple users can now work against the same database and build a shared knowledge vault together. The master owns the `main` branch and reviews changes; collaborators work on `collaborator/{name}` branches with automatic sync.

### Smart File Classification

Changed files are automatically classified as **additive** (examples, learnings, traces — safe to auto-merge) or **shared-state** (schema descriptions, business rules, domain model — needs PR review). Collaborators never have to think about merge conflicts.

### Background Sync

When running as an MCP server, collaborators get automatic periodic sync (default: every 60 minutes, configurable in `.collab.yaml`). Pull from main, push local changes, auto-merge what's safe, open PRs for the rest.

## New Features

### Collaboration Manifest (`.collab.yaml`)

A new file tracked in git stores team membership and sync settings:

```yaml
version: "1"
created_at: "2026-02-06T10:00:00+00:00"
members:
  - user_name: alice
    user_id: abcd1234
    role: master
    joined_at: "2026-02-06T10:00:00+00:00"
  - user_name: bob
    user_id: efgh5678
    role: collaborator
    joined_at: "2026-02-06T11:00:00+00:00"
sync:
  auto_sync: true
  sync_interval_minutes: 60
```

### CLI Commands

Six new subcommands under `db-mcp collab`:

| Command | Description |
|---------|-------------|
| `db-mcp collab init` | Master: create manifest, push to remote |
| `db-mcp collab join <url>` | Collaborator: clone vault, create branch, register |
| `db-mcp collab sync` | Pull from main, push changes (auto-merge or PR) |
| `db-mcp collab merge` | Master: auto-merge additive from all collaborator branches |
| `db-mcp collab status` | Show role, branch, sync config, pending changes |
| `db-mcp collab members` | List team members and roles |

### Git Backend Branch Operations

Eight new operations on `NativeGitBackend`: `checkout`, `fetch`, `merge`, `cherry_pick`, `current_branch`, `branch_exists`, `diff_names`, `push_branch`.

### GitHub PR Integration

When shared-state files are changed, `db-mcp collab sync` automatically opens a PR via `gh` CLI (if installed). Falls back gracefully to pushing the branch when `gh` is unavailable.

## Technical Details

### File Classification

| Category | Files | Merge Strategy |
|----------|-------|---------------|
| **Additive** | `examples/*.yaml`, `learnings/failures/*.yaml`, `learnings/*.md`, `traces/**` | Auto-merge to main |
| **Shared-state** | `schema/descriptions.yaml`, `domain/model.md`, `instructions/*`, `metrics/*`, `knowledge_gaps.yaml`, `feedback_log.yaml` | PR for master review |

### Sync Flow (Collaborator)

1. `fetch origin` + merge `origin/main` into collaborator branch
2. Stage and commit local changes
3. `diff --name-only main..collaborator/{name}` to find changes
4. Classify files → additive vs shared-state
5. If only additive: merge to main, push main
6. If shared-state present: push branch, open PR

### Background Sync

Hooks into `server_lifespan()` following the existing `TaskStore.start_cleanup_loop()` pattern. Uses `asyncio.to_thread()` to run blocking git operations without stalling the event loop.

## Files Changed

| File | Change |
|------|--------|
| `packages/core/src/db_mcp/collab/__init__.py` | New package |
| `packages/core/src/db_mcp/collab/manifest.py` | Manifest models, load/save, member management, user_name config |
| `packages/core/src/db_mcp/collab/classify.py` | File classification (additive vs shared-state) |
| `packages/core/src/db_mcp/collab/sync.py` | Collaborator sync engine (pull/push/auto-merge/PR) |
| `packages/core/src/db_mcp/collab/merge.py` | Master merge across all collaborator branches |
| `packages/core/src/db_mcp/collab/github.py` | `gh` CLI wrapper for PR creation |
| `packages/core/src/db_mcp/collab/background.py` | Async periodic sync loop |
| `packages/core/src/db_mcp/git_utils.py` | 8 branch operations on GitBackend ABC + NativeGitBackend |
| `packages/core/src/db_mcp/cli.py` | `collab` command group (6 subcommands), .gitignore update |
| `packages/core/src/db_mcp/server.py` | CollabSyncLoop in server_lifespan() |
| `packages/core/src/db_mcp/migrations/m_20260206_004_collab_gitignore.py` | Migration: allow .collab.yaml in existing .gitignore |

## Testing

- **448 Python tests** passing (81 new)
- Lint clean (ruff)
