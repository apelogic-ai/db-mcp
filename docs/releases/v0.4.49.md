# Release v0.4.49 - Fix Codex Config TOML Round-Trip

**Release Date:** February 6, 2026

## Overview

This release fixes a bug in the TOML writer used for OpenAI Codex agent configuration. Nested dictionary values (such as `env` maps on MCP servers) were silently dropped when db-mcp wrote back the config file, potentially corrupting existing Codex configurations.

## Highlights

### Codex Config Safety

Running `db-mcp init` or `db-mcp agents` no longer risks corrupting an existing Codex `config.toml`. The TOML writer now correctly preserves nested structures like `env` maps at any depth, so environment variables and other nested config on existing MCP servers survive the round-trip.

## Bug Fixes

### TOML Writer Drops Nested `env` Maps

The `_dict_to_toml` helper only handled two levels of nesting. Codex's `config.toml` supports `env` maps on MCP servers, which produces a three-level structure like `[mcp_servers.my-server.env]`. When db-mcp read an existing config with env maps and wrote it back, the env maps were silently lost.

**Before (broken):**
```toml
# Original config
[mcp_servers.my-server]
command = "npx"
args = ["-y", "some-pkg"]

[mcp_servers.my-server.env]
API_KEY = "secret"

# After db-mcp configures itself — env map is gone
[mcp_servers]

[mcp_servers.my-server]
command = "npx"
args = ["-y", "some-pkg"]

[mcp_servers.db-mcp]
command = "/usr/local/bin/db-mcp"
args = ["start"]
```

**After (fixed):**
```toml
# After db-mcp configures itself — env map preserved
[mcp_servers.my-server]
command = "npx"
args = ["-y", "some-pkg"]

[mcp_servers.my-server.env]
API_KEY = "secret"

[mcp_servers.db-mcp]
command = "/usr/local/bin/db-mcp"
args = ["start"]
```

### Spurious Empty `[mcp_servers]` Table Header

The old writer always emitted an empty `[mcp_servers]` section header before the actual server entries. While valid TOML, it was unnecessary noise. The new recursive writer only emits a table header when the table has its own scalar keys.

## Technical Details

Rewrote `_dict_to_toml` to be fully recursive, handling arbitrary nesting depth. Tables that only contain sub-tables (no scalar keys of their own) no longer emit an empty header. Renamed `_write_toml_value` to `_format_toml_value` for clarity.

## Files Changed

| File | Change |
|------|--------|
| `packages/core/src/db_mcp/agents.py` | Recursive TOML writer replacing the fixed-depth implementation |
| `packages/core/tests/test_agents.py` | 5 new tests: scalar formatting, no-spurious-header, env map round-trip, multi-server round-trip, full configure flow with env preservation |

## Testing

- **367 Python tests** passing (5 new)
- Lint clean (ruff)
