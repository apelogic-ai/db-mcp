# Release v0.4.51 - Collab Sync Refinements

**Release Date:** February 6, 2026

## Overview

Refines the collaborative sync protocol introduced in v0.4.50. Removes the redundant `collab join` command in favor of automatic collaborator registration during brownfield init. Splits sync into two modes: session (pull-on-start / push-on-stop) and daemon (periodic background loop).

## Highlights

### Zero-Friction Onboarding

Collaborators now join by running the existing `db-mcp init <name> <repo-url>` brownfield flow. If the cloned repo contains a `.collab.yaml` manifest, the user is automatically registered as a collaborator, assigned a branch, and added to the manifest. No separate `collab join` command needed.

### Two Sync Modes

- **Session mode** (default): When the MCP server starts (e.g. woken up by Claude), it pulls latest from main. When it shuts down, it pushes local changes. Zero configuration, works out of the box.
- **Daemon mode** (`db-mcp collab daemon`): Long-running process with periodic sync (default: every 60 minutes, configurable). Useful for sidecar deployments or always-on setups.

## Changes

### Removed

- **`db-mcp collab join`** — redundant with `db-mcp init <name> <repo-url>` brownfield flow

### Added

- **`_auto_register_collaborator()`** in brownfield init — detects `.collab.yaml`, prompts for user_name, creates collaborator branch, registers in manifest, commits and pushes
- **`db-mcp collab daemon`** command — long-running periodic sync with `--interval` flag (overrides manifest default)
- **Session mode sync hooks** — `server_lifespan()` now calls `collaborator_pull()` on startup and `collaborator_push()` on shutdown via `asyncio.to_thread()`

### Changed

- **Server lifespan** — replaced periodic `CollabSyncLoop` with one-shot pull/push hooks (session mode). The periodic loop is now exclusive to daemon mode.
- **`collab` group help text** — updated to reflect new onboarding flow and daemon command

## Files Changed

| File | Change |
|------|--------|
| `packages/core/src/db_mcp/cli.py` | Removed `collab join`, added `_auto_register_collaborator()`, added `collab daemon`, updated help text |
| `packages/core/src/db_mcp/server.py` | Replaced periodic `CollabSyncLoop` with pull-on-start / push-on-stop hooks |

## Testing

- **457 Python tests** passing (9 new in this release)
- New test files:
  - `test_collab_auto_register.py` — 4 tests (noop without manifest, new registration, already-registered skip, push failure handling)
  - `test_server_collab_lifespan.py` — 5 tests (pull on startup, push on shutdown, no manifest skip, master skip, pull failure resilience)
- Lint clean (ruff)
